<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>TremorPSD - An√°lise de Tremor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --primary: #007AFF;
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;
      --bg: #000000;
      --surface: #1C1C1E;
      --surface2: #2C2C2E;
      --text: #FFFFFF;
      --text-secondary: #8E8E93;
      --border: #38383A;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    
    /* Splash Screen / Onboarding */
    .onboarding {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s, transform 0.5s;
      padding: 20px;
    }
    
    .onboarding.hidden {
      opacity: 0;
      transform: scale(1.1);
      pointer-events: none;
    }
    
    .onboarding-icon {
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.2);
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
    }
    
    .onboarding-icon svg {
      width: 70px;
      height: 70px;
      fill: white;
    }
    
    .onboarding h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .onboarding p {
      font-size: 18px;
      opacity: 0.9;
      text-align: center;
      margin-bottom: 40px;
      max-width: 300px;
      line-height: 1.4;
    }
    
    .onboarding-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 18px 60px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .onboarding-btn:active {
      transform: scale(0.95);
    }
    
    .onboarding-steps {
      position: absolute;
      bottom: 40px;
      display: flex;
      gap: 8px;
    }
    
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transition: all 0.3s;
    }
    
    .step-dot.active {
      background: white;
      width: 24px;
      border-radius: 4px;
    }
    
    /* Main App */
    .app-header {
      background: var(--surface);
      padding: 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .app-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .app-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .content {
      padding: 20px;
      padding-bottom: 100px;
    }
    
    /* Status Card */
    .status-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
      transition: background 0.3s;
    }
    
    .status-card.ready::before { background: var(--success); }
    .status-card.collecting::before { background: var(--warning); }
    .status-card.error::before { background: var(--danger); }
    
    .status-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      position: relative;
    }
    
    .status-icon.pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    .status-text {
      text-align: center;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .status-detail {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    /* Control Panel */
    .control-panel {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: block;
    }
    
    .control-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      -webkit-appearance: none;
    }
    
    .control-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238E8E93' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }
    
    /* Action Button */
    .action-btn {
      width: 100%;
      padding: 18px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:active {
      transform: scale(0.98);
    }
    
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .action-btn.collecting {
      background: var(--warning);
    }
    
    .action-btn.success {
      background: var(--success);
    }
    
    .action-btn-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      transition: width linear;
    }
    
    /* Results Section */
    .results {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .results-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .chart-container {
      width: 100%;
      height: 200px;
      background: var(--surface2);
      border-radius: 12px;
      margin-bottom: 15px;
      position: relative;
    }
    
    canvas {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 15px;
    }
    
    .metric-card {
      background: var(--surface2);
      padding: 12px;
      border-radius: 12px;
    }
    
    .metric-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .metric-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    /* Classification */
    .classification {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .classification-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .classification-label {
      flex: 0 0 100px;
      font-size: 14px;
    }
    
    .classification-bar {
      flex: 1;
      height: 8px;
      background: var(--surface2);
      border-radius: 4px;
      overflow: hidden;
      margin: 0 10px;
    }
    
    .classification-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.5s ease;
      border-radius: 4px;
    }
    
    .classification-percent {
      flex: 0 0 50px;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
    }
    
    /* Footer Actions */
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 15px 20px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
      display: flex;
      gap: 10px;
    }
    
    .footer-btn {
      flex: 1;
      padding: 12px;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 375px) {
      .app-title { font-size: 20px; }
      .metrics-grid { grid-template-columns: 1fr; }
    }
    
    /* Hidden class */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Onboarding Screen -->
  <div class="onboarding" id="onboarding">
    <div class="onboarding-icon">
      <svg viewBox="0 0 24 24">
        <path d="M13.5,5.5C14.59,5.5 15.5,4.58 15.5,3.5C15.5,2.38 14.59,1.5 13.5,1.5C12.39,1.5 11.5,2.38 11.5,3.5C11.5,4.58 12.39,5.5 13.5,5.5M9.89,19.38L10.89,15L13,17V23H15V15.5L12.89,13.5L13.5,10.5C14.79,12 16.79,13 19,13V11C17.09,11 15.5,10 14.69,8.58L13.69,7C13.29,6.38 12.69,6 12,6C11.69,6 11.5,6.08 11.19,6.08L6,8.28V13H8V9.58L9.79,8.88L8.19,17L3.29,16L2.89,18L9.89,19.38Z"/>
      </svg>
    </div>
    <h1>TremorPSD</h1>
    <p>An√°lise profissional de tremor usando o aceler√¥metro do seu dispositivo</p>
    <button class="onboarding-btn" onclick="startOnboarding()">Come√ßar An√°lise</button>
    <div class="onboarding-steps">
      <span class="step-dot active"></span>
      <span class="step-dot"></span>
      <span class="step-dot"></span>
    </div>
  </div>
  
  <!-- Main App -->
  <div class="app-header">
    <div class="app-title">TremorPSD</div>
    <div class="app-subtitle">An√°lise de Tremor por Acelerometria</div>
  </div>
  
  <div class="content">
    <!-- Status Card -->
    <div class="status-card" id="statusCard">
      <div class="status-icon" id="statusIcon">
        <div class="spinner" id="spinner"></div>
        <svg id="iconReady" class="hidden" width="30" height="30" viewBox="0 0 24 24" fill="var(--success)">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
        </svg>
      </div>
      <div class="status-text" id="statusText">Preparando sensores...</div>
      <div class="status-detail" id="statusDetail">Aguarde um momento</div>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
      <div class="control-group">
        <label class="control-label">Dura√ß√£o da coleta (segundos)</label>
        <input type="number" class="control-input" id="duration" value="20" min="10" max="60">
      </div>
      
      <div class="control-group">
        <label class="control-label">Componente do sinal</label>
        <select class="control-select" id="axis">
          <option value="mag">Magnitude total (‚àöx¬≤+y¬≤+z¬≤)</option>
          <option value="x">Apenas eixo X</option>
          <option value="y">Apenas eixo Y</option>
          <option value="z">Apenas eixo Z</option>
        </select>
      </div>
      
      <button class="action-btn" id="actionBtn" onclick="handleAction()" disabled>
        <span id="actionText">Preparando...</span>
        <div class="action-btn-progress" id="progressBar"></div>
      </button>
    </div>
    
    <!-- Results Section (Initially Hidden) -->
    <div class="results hidden" id="resultsSection">
      <div class="results-title">An√°lise Espectral</div>
      
      <div class="chart-container">
        <canvas id="chartTime"></canvas>
      </div>
      
      <div class="chart-container">
        <canvas id="chartPSD"></canvas>
      </div>
      
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Frequ√™ncia do pico</div>
          <div class="metric-value" id="metricFreq">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Proemin√™ncia</div>
          <div class="metric-value" id="metricProm">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Largura (Hz)</div>
          <div class="metric-value" id="metricWidth">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Taxa (Hz)</div>
          <div class="metric-value" id="metricRate">‚Äî</div>
        </div>
      </div>
    </div>
    
    <!-- Classification (Initially Hidden) -->
    <div class="classification hidden" id="classificationSection">
      <div class="results-title">Classifica√ß√£o Sugerida</div>
      
      <div class="classification-item">
        <span class="classification-label">Ortost√°tico</span>
        <div class="classification-bar">
          <div class="classification-fill" id="barOT" style="width: 0%"></div>
        </div>
        <span class="classification-percent" id="pctOT">0%</span>
      </div>
      
      <div class="classification-item">
        <span class="classification-label">Essencial</span>
        <div class="classification-bar">
          <div class="classification-fill" id="barET" style="width: 0%"></div>
        </div>
        <span class="classification-percent" id="pctET">0%</span>
      </div>
      
      <div class="classification-item">
        <span class="classification-label">Dist√¥nico</span>
        <div class="classification-bar">
          <div class="classification-fill" id="barDT" style="width: 0%"></div>
        </div>
        <span class="classification-percent" id="pctDT">0%</span>
      </div>
      
      <div class="classification-item">
        <span class="classification-label">Mioclonia</span>
        <div class="classification-bar">
          <div class="classification-fill" id="barMY" style="width: 0%"></div>
        </div>
        <span class="classification-percent" id="pctMY">0%</span>
      </div>
    </div>
  </div>
  
  <!-- Footer Actions -->
  <div class="footer-actions hidden" id="footerActions">
    <button class="footer-btn" onclick="exportData()">Exportar CSV</button>
    <button class="footer-btn" onclick="resetApp()">Nova An√°lise</button>
  </div>

<script>
// Global state
let state = {
  onboarded: false,
  sensorReady: false,
  collecting: false,
  data: [],
  results: null,
  mode: 'mag',
  startTime: null,
  sampleRate: 0,
  eventCount: 0
};

// Check for HTTPS or secure context
function isSecureContext() {
  return location.protocol === 'https:' || 
         location.hostname === 'localhost' || 
         location.hostname === '127.0.0.1' ||
         location.hostname.includes('.local');
}

// Onboarding flow
async function startOnboarding() {
  const onboardingEl = document.getElementById('onboarding');
  
  // Check secure context first
  if (!isSecureContext()) {
    onboardingEl.querySelector('p').textContent = 'Por favor, acesse via HTTPS para usar os sensores';
    onboardingEl.querySelector('.onboarding-btn').textContent = 'Entendido';
    onboardingEl.querySelector('.onboarding-btn').onclick = () => {
      alert('Hospede este arquivo em HTTPS (GitHub Pages, Netlify, etc) para funcionar corretamente.');
    };
    return;
  }
  
  // Auto-request permission
  await requestSensorPermission();
  
  // Hide onboarding
  setTimeout(() => {
    onboardingEl.classList.add('hidden');
    state.onboarded = true;
    initializeApp();
  }, 500);
}

// Request sensor permission with multiple fallback strategies
async function requestSensorPermission() {
  try {
    // Strategy 1: iOS 13+ DeviceMotionEvent
    if (typeof DeviceMotionEvent !== 'undefined' && 
        typeof DeviceMotionEvent.requestPermission === 'function') {
      const response = await DeviceMotionEvent.requestPermission();
      if (response === 'granted') {
        state.sensorReady = true;
        return true;
      }
    }
    
    // Strategy 2: Android/Desktop - sensors usually work directly
    if (window.DeviceMotionEvent) {
      state.sensorReady = true;
      return true;
    }
    
    // Strategy 3: Generic Accelerometer API (newer devices)
    if ('Accelerometer' in window) {
      try {
        const sensor = new Accelerometer({ frequency: 60 });
        await sensor.start();
        sensor.stop();
        state.sensorReady = true;
        return true;
      } catch(e) {
        console.log('Accelerometer API not available');
      }
    }
    
  } catch(error) {
    console.error('Sensor permission error:', error);
  }
  
  return false;
}

// Initialize main app
function initializeApp() {
  const statusCard = document.getElementById('statusCard');
  const statusText = document.getElementById('statusText');
  const statusDetail = document.getElementById('statusDetail');
  const actionBtn = document.getElementById('actionBtn');
  const actionText = document.getElementById('actionText');
  const spinner = document.getElementById('spinner');
  const iconReady = document.getElementById('iconReady');
  
  // Setup event listeners
  setupMotionListener();
  
  // Check sensor availability
  setTimeout(() => {
    if (state.eventCount > 0) {
      statusCard.classList.add('ready');
      spinner.classList.add('hidden');
      iconReady.classList.remove('hidden');
      statusText.textContent = 'Pronto para an√°lise';
      statusDetail.textContent = `Taxa: ${state.sampleRate.toFixed(0)} Hz`;
      actionBtn.disabled = false;
      actionText.textContent = 'Iniciar Coleta';
      document.getElementById('statusIcon').classList.add('pulse');
    } else {
      // Auto-retry with visual feedback
      statusText.textContent = 'Ativando sensores...';
      statusDetail.textContent = 'Mova o dispositivo levemente';
      retrySetup();
    }
  }, 1500);
}

// Setup motion event listener
function setupMotionListener() {
  let lastTime = null;
  
  const handleMotion = (event) => {
    state.eventCount++;
    
    // Calculate sample rate
    const now = Date.now();
    if (lastTime) {
      const dt = (now - lastTime) / 1000;
      state.sampleRate = state.sampleRate * 0.9 + (1/dt) * 0.1;
    }
    lastTime = now;
    
    // Collect data if in collection mode
    if (state.collecting) {
      const acc = event.acceleration || event.accelerationIncludingGravity;
      if (acc) {
        const ax = acc.x || 0;
        const ay = acc.y || 0;
        const az = acc.z || 0;
        
        let value = 0;
        switch(state.mode) {
          case 'mag':
            value = Math.sqrt(ax*ax + ay*ay + az*az);
            break;
          case 'x': value = ax; break;
          case 'y': value = ay; break;
          case 'z': value = az; break;
        }
        
        const timestamp = (now - state.startTime) / 1000;
        state.data.push([timestamp, value]);
        
        // Update progress
        updateProgress();
      }
    }
  };
  
  // Remove old listeners
  window.removeEventListener('devicemotion', handleMotion);
  
  // Add new listener
  window.addEventListener('devicemotion', handleMotion, true);
}

// Retry setup with haptic feedback
function retrySetup() {
  // Vibrate if available (haptic feedback)
  if ('vibrate' in navigator) {
    navigator.vibrate(100);
  }
  
  // Create a subtle animation to prompt user interaction
  const statusIcon = document.getElementById('statusIcon');
  statusIcon.style.animation = 'pulse 1s infinite';
  
  // Check again after user movement
  setTimeout(() => {
    if (state.eventCount > 0) {
      initializeApp();
    } else {
      document.getElementById('statusText').textContent = 'Toque para ativar';
      document.getElementById('statusDetail').textContent = 'Precisamos de sua permiss√£o';
      document.getElementById('actionBtn').disabled = false;
      document.getElementById('actionText').textContent = 'Ativar Sensores';
      document.getElementById('actionBtn').onclick = async () => {
        await requestSensorPermission();
        setupMotionListener();
        setTimeout(() => initializeApp(), 1000);
      };
    }
  }, 2000);
}

// Handle main action button
function handleAction() {
  if (!state.collecting) {
    startCollection();
  } else {
    stopCollection();
  }
}

// Start data collection
function startCollection() {
  // Reset state
  state.data = [];
  state.collecting = true;
  state.startTime = Date.now();
  state.mode = document.getElementById('axis').value;
  
  // Update UI
  const statusCard = document.getElementById('statusCard');
  const actionBtn = document.getElementById('actionBtn');
  statusCard.classList.remove('ready');
  statusCard.classList.add('collecting');
  actionBtn.classList.add('collecting');
  
  document.getElementById('statusText').textContent = 'Coletando dados...';
  document.getElementById('statusDetail').textContent = 'Mantenha o dispositivo est√°vel';
  document.getElementById('actionText').textContent = 'Parar Coleta';
  
  // Auto-stop after duration
  const duration = parseInt(document.getElementById('duration').value) || 20;
  setTimeout(() => {
    if (state.collecting) stopCollection();
  }, duration * 1000);
}

// Update progress bar
function updateProgress() {
  if (!state.collecting) return;
  
  const duration = parseInt(document.getElementById('duration').value) || 20;
  const elapsed = (Date.now() - state.startTime) / 1000;
  const progress = Math.min(100, (elapsed / duration) * 100);
  
  document.getElementById('progressBar').style.width = `${progress}%`;
  document.getElementById('progressBar').style.transitionDuration = '0.1s';
  
  // Update detail text
  const remaining = Math.max(0, duration - elapsed);
  document.getElementById('statusDetail').textContent = `${remaining.toFixed(0)}s restantes | ${state.data.length} amostras`;
}

// Stop collection and analyze
function stopCollection() {
  state.collecting = false;
  
  // Update UI
  const statusCard = document.getElementById('statusCard');
  const actionBtn = document.getElementById('actionBtn');
  statusCard.classList.remove('collecting');
  actionBtn.classList.remove('collecting');
  actionBtn.classList.add('success');
  
  document.getElementById('statusText').textContent = 'Analisando...';
  document.getElementById('statusDetail').textContent = 'Processando dados';
  document.getElementById('actionText').textContent = 'An√°lise Completa';
  document.getElementById('progressBar').style.width = '0%';
  
  // Vibrate for completion
  if ('vibrate' in navigator) {
    navigator.vibrate([100, 50, 100]);
  }
  
  // Analyze data
  setTimeout(() => {
    analyzeData();
  }, 500);
}

// Simplified FFT implementation
function computeFFT(signal) {
  const n = signal.length;
  const nextPow2 = Math.pow(2, Math.ceil(Math.log2(n)));
  const padded = new Float64Array(nextPow2);
  padded.set(signal);
  
  // Simple DFT for demonstration (replace with proper FFT in production)
  const real = new Float64Array(nextPow2);
  const imag = new Float64Array(nextPow2);
  
  for (let k = 0; k < nextPow2/2; k++) {
    for (let n = 0; n < nextPow2; n++) {
      const angle = -2 * Math.PI * k * n / nextPow2;
      real[k] += padded[n] * Math.cos(angle);
      imag[k] += padded[n] * Math.sin(angle);
    }
  }
  
  // Compute power spectrum
  const power = new Float64Array(nextPow2/2);
  for (let i = 0; i < nextPow2/2; i++) {
    power[i] = Math.sqrt(real[i]*real[i] + imag[i]*imag[i]);
  }
  
  return power;
}

// Analyze collected data
function analyzeData() {
  if (state.data.length < 50) {
    document.getElementById('statusText').textContent = 'Dados insuficientes';
    document.getElementById('statusDetail').textContent = 'Tente novamente com mais tempo';
    return;
  }
  
  // Extract time and signal arrays
  const times = state.data.map(d => d[0]);
  const signal = state.data.map(d => d[1]);
  
  // Remove DC component (detrend)
  const mean = signal.reduce((a, b) => a + b, 0) / signal.length;
  const detrended = signal.map(v => v - mean);
  
  // Compute sample rate
  const dt = times[times.length-1] / (times.length-1);
  const fs = 1 / dt;
  
  // Compute FFT
  const spectrum = computeFFT(detrended);
  
  // Create frequency array
  const freqs = new Float64Array(spectrum.length);
  for (let i = 0; i < spectrum.length; i++) {
    freqs[i] = i * fs / (spectrum.length * 2);
  }
  
  // Find peak frequency
  let peakIdx = 0;
  let peakValue = 0;
  for (let i = 1; i < spectrum.length; i++) {
    if (freqs[i] > 1 && freqs[i] < 30) { // Search between 1-30 Hz
      if (spectrum[i] > peakValue) {
        peakValue = spectrum[i];
        peakIdx = i;
      }
    }
  }
  
  const peakFreq = freqs[peakIdx];
  
  // Calculate metrics
  const prominence = peakValue / (spectrum.reduce((a,b) => a+b, 0) / spectrum.length);
  
  // Calculate FWHM (Full Width at Half Maximum)
  const halfMax = peakValue / 2;
  let leftIdx = peakIdx;
  let rightIdx = peakIdx;
  while (leftIdx > 0 && spectrum[leftIdx] > halfMax) leftIdx--;
  while (rightIdx < spectrum.length-1 && spectrum[rightIdx] > halfMax) rightIdx++;
  const width = freqs[rightIdx] - freqs[leftIdx];
  
  // Store results
  state.results = {
    times: times,
    signal: detrended,
    freqs: freqs,
    spectrum: spectrum,
    peakFreq: peakFreq,
    prominence: prominence,
    width: width,
    sampleRate: fs
  };
  
  // Display results
  displayResults();
  
  // Classify tremor type
  classifyTremor();
  
  // Update UI
  document.getElementById('statusCard').classList.add('ready');
  document.getElementById('statusText').textContent = 'An√°lise completa';
  document.getElementById('statusDetail').textContent = `Frequ√™ncia dominante: ${peakFreq.toFixed(1)} Hz`;
  document.getElementById('actionBtn').disabled = true;
  document.getElementById('footerActions').classList.remove('hidden');
}

// Display analysis results
function displayResults() {
  const { times, signal, freqs, spectrum, peakFreq, prominence, width, sampleRate } = state.results;
  
  // Show results section
  document.getElementById('resultsSection').classList.remove('hidden');
  
  // Update metrics
  document.getElementById('metricFreq').textContent = `${peakFreq.toFixed(1)} Hz`;
  document.getElementById('metricProm').textContent = prominence.toFixed(1);
  document.getElementById('metricWidth').textContent = `${width.toFixed(2)} Hz`;
  document.getElementById('metricRate').textContent = `${sampleRate.toFixed(0)} Hz`;
  
  // Plot time series
  plotTimeSeries(times, signal);
  
  // Plot spectrum
  plotSpectrum(freqs, spectrum, peakFreq);
}

// Plot time series
function plotTimeSeries(times, signal) {
  const canvas = document.getElementById('chartTime');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size for retina displays
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * window.devicePixelRatio;
  canvas.height = rect.height * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  
  // Clear canvas
  ctx.clearRect(0, 0, rect.width, rect.height);
  
  // Calculate bounds
  const padding = 20;
  const width = rect.width - 2 * padding;
  const height = rect.height - 2 * padding;
  
  const minT = Math.min(...times);
  const maxT = Math.max(...times);
  const minS = Math.min(...signal);
  const maxS = Math.max(...signal);
  const rangeS = maxS - minS || 1;
  
  // Draw grid
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padding + i * height / 5;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(rect.width - padding, y);
    ctx.stroke();
  }
  
  // Draw signal
  ctx.strokeStyle = '#007AFF';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  for (let i = 0; i < times.length; i++) {
    const x = padding + (times[i] - minT) / (maxT - minT) * width;
    const y = padding + (1 - (signal[i] - minS) / rangeS) * height;
    
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  
  ctx.stroke();
  
  // Add label
  ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
  ctx.font = '12px system-ui';
  ctx.fillText('Sinal Temporal', padding, padding - 5);
}

// Plot frequency spectrum
function plotSpectrum(freqs, spectrum, peakFreq) {
  const canvas = document.getElementById('chartPSD');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size for retina displays
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * window.devicePixelRatio;
  canvas.height = rect.height * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  
  // Clear canvas
  ctx.clearRect(0, 0, rect.width, rect.height);
  
  // Calculate bounds (limit to 0-30 Hz)
  const padding = 20;
  const width = rect.width - 2 * padding;
  const height = rect.height - 2 * padding;
  
  const maxFreq = Math.min(30, Math.max(...freqs));
  const maxSpec = Math.max(...spectrum);
  
  // Draw grid
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padding + i * height / 5;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(rect.width - padding, y);
    ctx.stroke();
  }
  
  // Draw spectrum
  ctx.strokeStyle = '#34C759';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  for (let i = 0; i < freqs.length && freqs[i] <= maxFreq; i++) {
    const x = padding + freqs[i] / maxFreq * width;
    const y = padding + (1 - spectrum[i] / maxSpec) * height;
    
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  
  ctx.stroke();
  
  // Mark peak
  const peakIdx = freqs.findIndex(f => f >= peakFreq);
  if (peakIdx >= 0) {
    const x = padding + peakFreq / maxFreq * width;
    const y = padding + (1 - spectrum[peakIdx] / maxSpec) * height;
    
    ctx.fillStyle = '#FF3B30';
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, 2 * Math.PI);
    ctx.fill();
    
    // Add peak label
    ctx.fillStyle = '#FF3B30';
    ctx.font = '11px system-ui';
    ctx.fillText(`${peakFreq.toFixed(1)} Hz`, x + 8, y + 3);
  }
  
  // Add label
  ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
  ctx.font = '12px system-ui';
  ctx.fillText('Espectro de Frequ√™ncia', padding, padding - 5);
}

// Classify tremor type based on frequency characteristics
function classifyTremor() {
  if (!state.results) return;
  
  const { peakFreq, prominence, width } = state.results;
  
  // Show classification section
  document.getElementById('classificationSection').classList.remove('hidden');
  
  // Simple heuristic classification
  let scores = {
    OT: 0,  // Orthostatic
    ET: 0,  // Essential
    DT: 0,  // Dystonic
    MY: 0   // Myoclonus
  };
  
  // Orthostatic tremor: 13-18 Hz, high prominence
  if (peakFreq >= 13 && peakFreq <= 18) {
    scores.OT = prominence > 5 ? 0.9 : 0.6;
  }
  
  // Essential tremor: 4-12 Hz
  if (peakFreq >= 4 && peakFreq <= 12) {
    scores.ET = 0.8 - Math.abs(peakFreq - 7) * 0.1;
  }
  
  // Dystonic tremor: 4-7 Hz, broader spectrum
  if (peakFreq >= 4 && peakFreq <= 7 && width > 1.5) {
    scores.DT = 0.7;
  }
  
  // Myoclonus: irregular, broad spectrum
  if (width > 3 && prominence < 3) {
    scores.MY = 0.6;
  }
  
  // Normalize scores to percentages
  const total = Math.max(0.001, scores.OT + scores.ET + scores.DT + scores.MY);
  
  // Update UI with animation
  setTimeout(() => {
    animateClassification('OT', scores.OT / total * 100);
    animateClassification('ET', scores.ET / total * 100);
    animateClassification('DT', scores.DT / total * 100);
    animateClassification('MY', scores.MY / total * 100);
  }, 100);
}

// Animate classification bars
function animateClassification(type, percentage) {
  const bar = document.getElementById(`bar${type}`);
  const pct = document.getElementById(`pct${type}`);
  
  bar.style.width = `${percentage}%`;
  pct.textContent = `${Math.round(percentage)}%`;
  
  // Color based on confidence
  if (percentage > 60) {
    bar.style.background = 'var(--success)';
  } else if (percentage > 30) {
    bar.style.background = 'var(--warning)';
  } else {
    bar.style.background = 'var(--primary)';
  }
}

// Export data as CSV
function exportData() {
  if (!state.data || state.data.length === 0) return;
  
  let csv = 'Time (s),Acceleration\n';
  state.data.forEach(row => {
    csv += `${row[0].toFixed(6)},${row[1].toFixed(6)}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tremor_analysis_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  // Vibrate for feedback
  if ('vibrate' in navigator) {
    navigator.vibrate(50);
  }
}

// Reset app for new analysis
function resetApp() {
  // Reset state
  state.data = [];
  state.results = null;
  state.collecting = false;
  
  // Reset UI
  document.getElementById('resultsSection').classList.add('hidden');
  document.getElementById('classificationSection').classList.add('hidden');
  document.getElementById('footerActions').classList.add('hidden');
  document.getElementById('statusCard').classList.remove('collecting', 'ready', 'error');
  document.getElementById('statusCard').classList.add('ready');
  document.getElementById('statusText').textContent = 'Pronto para nova an√°lise';
  document.getElementById('statusDetail').textContent = `Taxa: ${state.sampleRate.toFixed(0)} Hz`;
  document.getElementById('actionBtn').disabled = false;
  document.getElementById('actionBtn').classList.remove('success', 'collecting');
  document.getElementById('actionText').textContent = 'Iniciar Coleta';
  document.getElementById('progressBar').style.width = '0%';
  
  // Reset classification bars
  ['OT', 'ET', 'DT', 'MY'].forEach(type => {
    document.getElementById(`bar${type}`).style.width = '0%';
    document.getElementById(`pct${type}`).textContent = '0%';
  });
  
  // Vibrate for feedback
  if ('vibrate' in navigator) {
    navigator.vibrate(50);
  }
}

// Auto-initialize on load
window.addEventListener('load', () => {
  // Check if already onboarded (for return visits)
  if (localStorage.getItem('tremor_onboarded')) {
    document.getElementById('onboarding').classList.add('hidden');
    state.onboarded = true;
    requestSensorPermission().then(() => {
      initializeApp();
    });
  }
});

// Save onboarding state
window.addEventListener('beforeunload', () => {
  if (state.onboarded) {
    localStorage.setItem('tremor_onboarded', 'true');
  }
});

// Handle orientation changes
window.addEventListener('orientationchange', () => {
  // Redraw canvases
  if (state.results) {
    setTimeout(() => {
      displayResults();
    }, 100);
  }
});

// Progressive Web App capabilities
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {
    // Service worker registration failed, app still works
  });
}
</script>

<!-- Optional PWA Service Worker -->
<script id="sw.js">
// Basic service worker for offline capability
self.addEventListener('install', (event) => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(clients.claim());
});

self.addEventListener('fetch', (event) => {
  event.respondWith(fetch(event.request).catch(() => {
    return new Response('Offline');
  }));
});
</script>

</body>
</html>